# M10 Ops

## Added
- New internal endpoint: `POST /internal/promo/redeem`.
- New internal metrics endpoint: `GET /internal/promo/dashboard`.
  - Returns promo conversion metrics (attempt acceptance, discount reservation->applied),
  - failure-rate breakdown by promo attempt result,
  - guard indicators (candidate abusive hashes, paused campaigns totals/recent).
- New internal admin promo endpoints:
  - `GET /internal/promo/campaigns` (campaign listing with filters);
  - `POST /internal/promo/campaigns/{promo_code_id}/status` (safe `ACTIVE <-> PAUSED` transitions);
  - `POST /internal/promo/refund-rollback` (manual refund rollback to `PR_REVOKED` path).
- New Celery periodic jobs:
  - `run_promo_reservation_expiry` every 1 minute;
  - `run_promo_campaign_status_rollover` every 10 minutes;
  - `run_promo_bruteforce_guard` every 1 minute.
  - `run_refund_promo_rollback` every 5 minutes (idempotent rollback for refunded purchases with promo redemptions).
- Structured logs for promo maintenance and autopause outcomes.
- Provider-specific ops alert routing with escalation policy:
  - channels: `generic`, `slack`, `pagerduty`;
  - default event routing:
    - `promo_campaign_auto_paused` -> `warning`, `ops_l2`, `slack + generic`;
    - `payments_reconciliation_diff_detected` -> `critical`, `ops_l1`, `pagerduty + slack + generic`;
    - `payments_recovery_review_required` -> `error`, `ops_l1`, `pagerduty + slack + generic`;
  - optional per-event overrides through `OPS_ALERT_ESCALATION_POLICY_JSON`.
- Generic webhook channel (`OPS_ALERT_WEBHOOK_URL`) remains supported for backward compatibility.
- New provider env settings:
  - `OPS_ALERT_SLACK_WEBHOOK_URL`;
  - `OPS_ALERT_PAGERDUTY_EVENTS_URL` (default `https://events.pagerduty.com/v2/enqueue`);
  - `OPS_ALERT_PAGERDUTY_ROUTING_KEY`;
  - `OPS_ALERT_ESCALATION_POLICY_JSON`.
- Alert events wired in workers:
  - promo campaign autopause events;
  - payment reconciliation diffs;
  - payment recovery review-required outcomes.
- New runbook:
  - `docs/runbooks/telegram_sandbox_stars_smoke.md` for external Telegram sandbox validation of promo/payment and referral duplicate-callback safety.
  - `docs/runbooks/promo_incident_response.md` for promo autopause triage and safe manual unpause procedure.
