# NEXT_AGENT_BRIEF

## Current State
- M1-M5 completed (foundation, schema, energy, streak, free-loop gameplay).
- M6 completed beyond slice 1:
  - webhook endpoint + async update queue (`/webhook/telegram`);
  - payment recovery + reconciliation jobs;
  - anti-repeat question selection and persisted `question_id`;
  - Postgres integration tests for idempotent payment credit replay;
  - promo discount settlement in purchase flow.
- M7 completed:
  - all 4 premium plans in catalog;
  - premium entitlement grant on payment;
  - upgrade extension behavior + downgrade block.
- M8 completed:
  - offer trigger engine with deterministic priority resolver;
  - anti-spam caps (6h blocking modal, 3/day, same offer 24h, mute 72h);
  - idempotent `offers_impressions` logging and bot offer surfaces (`/start`, locked mode, energy empty);
  - offer dismiss callback flow (`offer:dismiss:<impression_id>`).
- Offer observability hardening completed:
  - CTA attribution in payments (`buy:<product>:offer:<impression_id>` -> `clicked_at` + `converted_purchase_id`);
  - internal offers dashboard endpoint `GET /internal/offers/dashboard`;
  - periodic offers monitor with threshold-based ops alerts (conversion drop + spam anomalies).
- M9 completed:
  - referral start tracking via `/start ref_<code>` onboarding payload;
  - referral qualification checks (20 attempts / 14d / 2 local days);
  - anti-fraud guards (cyclic pair + velocity limit);
  - reward distribution with 48h delay, `3 qualified -> 1 reward`, monthly cap `2`, deferred rollover.
  - referral UX wired in bot:
    - home CTA `referral:open`;
    - `/referral` and `/invite` commands;
    - reward choice callbacks `referral:reward:MEGA_PACK_15|PREMIUM_STARTER`.
  - referral rewards now use explicit user choice flow:
    - worker marks eligible slots as `awaiting_choice` (no auto-grant);
    - `claim_next_reward_choice` applies selected reward.
  - hardening coverage added:
    - duplicate claim idempotency (sequential + concurrent callback replay);
    - worker-vs-choice race safety test.
- Referral observability hardening completed:
  - internal referral dashboard endpoint `GET /internal/referrals/dashboard`;
  - referral fraud triage metrics (status funnel, fraud rates, top suspicious referrers, recent fraud cases);
  - periodic referral fraud-spike monitor with threshold-based ops alerting.
- Referral manual-review workflow delivered:
  - `GET /internal/referrals/review-queue`;
  - `POST /internal/referrals/{referral_id}/review` with decisions `CONFIRM_FRAUD|REOPEN|CANCEL`;
  - runbook `docs/runbooks/referrals_fraud_review.md` for triage/tuning flow.
- M10 core promo module is now implemented:
  - `POST /internal/promo/redeem` (`PREMIUM_GRANT`, `PERCENT_DISCOUNT`);
  - promo anti-abuse throttling (per-user + global brute-force autopause);
  - promo maintenance jobs (reservation expiry, campaign rollover, brute-force guard);
  - bot-level promo UX (`/promo <code>`, `promo:open`).
- Promo observability dashboard endpoint delivered:
  - `GET /internal/promo/dashboard` (internal token + IP allowlist protected);
  - conversion metrics (attempt acceptance + discount reservation->applied);
  - failure breakdown by promo attempt result;
  - guard indicators (candidate abusive hashes, paused campaign totals/recent).
- Promo operations hardening completed:
  - internal campaign admin workflow endpoints:
    - `GET /internal/promo/campaigns`;
    - `POST /internal/promo/campaigns/{promo_code_id}/status`;
    - `POST /internal/promo/refund-rollback`.
  - safe mutable status transitions limited to `ACTIVE <-> PAUSED`.
  - refund-driven promo rollback automation:
    - worker `run_refund_promo_rollback` every 5 minutes;
    - `promo_redemptions.status` transitions to `REVOKED` for refunded promo purchases.
  - refund rollback accounting invariant:
    - `promo_codes.used_total` is not decremented on refund rollback.
- Additional hardening completed in this session:
  - internal endpoint auth for promo redeem (`X-Internal-Token` + IP allowlist);
  - single active invoice lock per `(user_id, product_code)` (service + DB partial unique index);
  - `STREAK_SAVER_20` purchase limit enforced (once per 7 days);
  - payments reliability upgrades:
    - stale unpaid invoices (`CREATED`/`INVOICE_SENT`) auto-expire to `FAILED`;
    - reconciliation compares counts + stars totals + product-level stars drift;
    - generic ops webhook alerts on reconciliation diff and recovery review-required;
  - daily challenge DB uniqueness guarantee (one per user per Berlin day);
  - promo hardening:
    - parallel redeem collision integration test;
    - promo batch generation/import CLI (`scripts/promo_batch_tool.py`);
    - generic ops alert webhook for promo autopause events.
  - provider-specific on-call alert routing:
    - event templates for Slack/PagerDuty/generic webhook;
    - escalation policy tiers (`ops_l1/ops_l2/ops_l3`) with per-event overrides via env JSON.
  - bot promo purchase wiring:
    - promo discount success now returns targeted `buy:<product_code>:promo:<redemption_id>` callbacks;
    - payment handler accepts promo-bound buy callbacks and settles discount through purchase flow.
  - Telegram webhook smoke scenarios:
    - `/promo` redeem -> buy callback -> precheckout -> successful payment -> credit;
    - referral reward choice callback duplicate replay safety;
    - dispatcher router-attachment issue fixed via singleton dispatcher reuse.
  - external Telegram sandbox runbook:
    - `docs/runbooks/telegram_sandbox_stars_smoke.md` with webhook binding, scenario steps, DB validation and cleanup.
  - promo incident response runbook:
    - `docs/runbooks/promo_incident_response.md` for autopause triage and safe manual unpause.
- Latest UX/runtime adjustments (2026-02-18):
  - quiz loop remains continuous in standard modes until energy is depleted;
  - home/shop buttons were made more visible (uppercase + emoji labels + explicit home action hint);
  - shop now keeps focused premium lineup (`PREMIUM_STARTER`, `PREMIUM_MONTH`) and promo entry inside shop;
  - promo input UX accepts `/promo CODE`, `promo CODE`, reply-to-prompt, and standalone code message; success/error texts were clarified for user feedback;
  - question rendering improved with stronger visual separation (`Frage:` + bold question body);
  - offer keyboard no longer includes the dismiss CTA (`Nicht zeigen (72h)`);
  - when energy is empty, purchase options are shown immediately (offer CTA buttons remain visible, dismiss action removed).
- Local environment data change (manual, non-migration):
  - promo code `CHIK` created directly in local Postgres via `scripts/promo_batch_tool.py`;
  - campaign `manual_chik_starter`, type `PREMIUM_GRANT`, grant `7` days, scope `PREMIUM_ANY`, status `ACTIVE`;
  - validity window: `2026-02-18T00:00:00Z` -> `2027-12-31T23:59:59Z`.
- Technical spec source of truth: `TECHNICAL_SPEC_ENERGY_STARS_BOT.md`.

## Critical Notes
- `.env` is local-only and must never be committed.
- Bot token is already configured locally; rotate token before production webhook go-live.
- Local runtime services are expected to be started manually when needed (`postgres`, `redis`, API, bot, worker).
- Latest full validation run in this branch: `148 passed` (2026-02-18).
- Latest targeted validation run (2026-02-20): referral review queue/decision tests passed.
- Current Alembic head: `d5e6f7a8b9c0`.

## Immediate Next Steps (Priority)
1. Product notifications:
  - external notification channel for referral milestone/reward events.
2. Promo ops UX:
  - standalone visual admin UI over implemented internal promo admin endpoints.
3. Referral ops UX:
  - standalone visual review UI over implemented referral triage APIs.

## Validation Commands
- `TMPDIR=/tmp .venv/bin/python -m pytest -q`
- `.venv/bin/ruff check app tests alembic scripts`
- `TMPDIR=/tmp .venv/bin/alembic heads`
