name: CI

on:
  push:
  pull_request:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint_unit:
    runs-on: ubuntu-latest

    env:
      APP_ENV: test
      LOG_LEVEL: INFO
      TELEGRAM_BOT_TOKEN: ci-test-token
      TELEGRAM_WEBHOOK_SECRET: ci-test-secret
      INTERNAL_API_TOKEN: ci-internal-token
      PROMO_SECRET_PEPPER: ci-test-promo-pepper
      TEST_DATABASE_URL: postgresql+asyncpg://postgres:postgres@127.0.0.1:5432/quiz_arena_test
      DATABASE_URL: postgresql+asyncpg://postgres:postgres@127.0.0.1:5432/quiz_arena_test
      REDIS_URL: redis://127.0.0.1:6379/0
      CELERY_BROKER_URL: redis://127.0.0.1:6379/1
      CELERY_RESULT_BACKEND: redis://127.0.0.1:6379/2
      TMPDIR: /tmp

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: |
            requirements.lock
            requirements-dev.lock

      - name: Verify lockfiles are in sync with pyproject
        run: |
          python -m pip install --upgrade pip pip-tools
          cp requirements.lock /tmp/requirements.lock.prev
          cp requirements-dev.lock /tmp/requirements-dev.lock.prev
          pip-compile --strip-extras pyproject.toml --output-file requirements.lock
          pip-compile --strip-extras --extra dev pyproject.toml --output-file requirements-dev.lock
          diff -u /tmp/requirements.lock.prev requirements.lock
          diff -u /tmp/requirements-dev.lock.prev requirements-dev.lock

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements-dev.lock
          python -m pip install --no-deps -e .

      - name: Verify QuizBank reports freshness
        run: python scripts/quizbank_reports.py check

      - name: Validate TEST_DATABASE_URL safety
        run: |
          python - <<'PY'
          import os
          from sqlalchemy.engine import make_url

          db_name = (make_url(os.environ["TEST_DATABASE_URL"]).database or "").strip()
          if "test" not in db_name.lower():
              raise SystemExit(f"TEST_DATABASE_URL DB name must contain 'test', got: {db_name!r}")
          print(f"Using safe TEST_DATABASE_URL database: {db_name}")
          PY

      - name: Architecture guards
        run: |
          bash scripts/check_line_limits.sh
          bash scripts/check_growth_delta.sh
          bash scripts/check_monolith_pattern.sh
          bash scripts/check_no_print_app.sh
          bash scripts/check_no_except_exception_pass.sh
          bash scripts/check_architecture_imports.sh
          bash scripts/check_import_cycles.sh

      - name: Ruff
        run: ruff check app tests

      - name: Black
        run: black --check app tests

      - name: isort
        run: isort --check-only app tests

      - name: Mypy
        run: mypy app tests

      - name: Pytest (unit and bot)
        env:
          DATABASE_URL: ${{ env.TEST_DATABASE_URL }}
        run: python -m pytest -q --ignore=tests/integration

  integration:
    runs-on: ubuntu-latest
    needs: lint_unit

    services:
      postgres:
        image: postgres:16.4
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: quiz_arena_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres -d quiz_arena_test"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    env:
      APP_ENV: test
      LOG_LEVEL: INFO
      TELEGRAM_BOT_TOKEN: ci-test-token
      TELEGRAM_WEBHOOK_SECRET: ci-test-secret
      INTERNAL_API_TOKEN: ci-internal-token
      PROMO_SECRET_PEPPER: ci-test-promo-pepper
      TEST_DATABASE_URL: postgresql+asyncpg://postgres:postgres@127.0.0.1:5432/quiz_arena_test
      DATABASE_URL: postgresql+asyncpg://postgres:postgres@127.0.0.1:5432/quiz_arena_test
      REDIS_URL: redis://127.0.0.1:6379/0
      CELERY_BROKER_URL: redis://127.0.0.1:6379/1
      CELERY_RESULT_BACKEND: redis://127.0.0.1:6379/2
      TMPDIR: /tmp

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: |
            requirements.lock
            requirements-dev.lock

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements-dev.lock
          python -m pip install --no-deps -e .

      - name: Validate TEST_DATABASE_URL safety
        run: |
          python - <<'PY'
          import os
          from sqlalchemy.engine import make_url

          db_name = (make_url(os.environ["TEST_DATABASE_URL"]).database or "").strip()
          if "test" not in db_name.lower():
              raise SystemExit(f"TEST_DATABASE_URL DB name must contain 'test', got: {db_name!r}")
          print(f"Using safe TEST_DATABASE_URL database: {db_name}")
          PY

      - name: Wait for Postgres and Redis
        run: |
          python - <<'PY'
          import asyncio
          import os
          import time

          import asyncpg
          from sqlalchemy.engine import make_url
          from redis.asyncio import Redis

          def _asyncpg_dsn(database_url: str) -> str:
              parsed = make_url(database_url)
              normalized = parsed.set(drivername="postgresql")
              return normalized.render_as_string(hide_password=False)

          async def wait_for_postgres() -> None:
              deadline = time.monotonic() + 90
              last_error: Exception | None = None
              dsn = _asyncpg_dsn(os.environ["TEST_DATABASE_URL"])
              while time.monotonic() < deadline:
                  try:
                      conn = await asyncpg.connect(dsn)
                      await conn.close()
                      print("Postgres is ready")
                      return
                  except Exception as exc:  # pragma: no cover - CI boot timing dependent
                      last_error = exc
                      await asyncio.sleep(2)
              raise RuntimeError(f"Postgres did not become ready in time: {last_error}")

          async def wait_for_redis() -> None:
              deadline = time.monotonic() + 90
              last_error: Exception | None = None
              while time.monotonic() < deadline:
                  client = Redis.from_url(os.environ["REDIS_URL"])
                  try:
                      if await client.ping():
                          print("Redis is ready")
                          return
                  except Exception as exc:  # pragma: no cover - CI boot timing dependent
                      last_error = exc
                  finally:
                      await client.aclose()
                  await asyncio.sleep(2)
              raise RuntimeError(f"Redis did not become ready in time: {last_error}")

          async def main() -> None:
              await wait_for_postgres()
              await wait_for_redis()

          asyncio.run(main())
          PY

      - name: Apply migrations
        env:
          DATABASE_URL: ${{ env.TEST_DATABASE_URL }}
        run: python -m alembic upgrade head

      - name: QuizBank import dry-run
        env:
          DATABASE_URL: ${{ env.TEST_DATABASE_URL }}
        run: python -m scripts.quizbank_import_tool --dry-run

      - name: Pytest (integration)
        env:
          DATABASE_URL: ${{ env.TEST_DATABASE_URL }}
        run: python -m pytest -q -s tests/integration
